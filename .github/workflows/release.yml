name: ðŸš€ Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  release:
    name: ðŸ“¦ Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŒ™ Setup MoonBit
      uses: moonbitlang/setup-moonbit@v1
      with:
        version: 'latest'
        
    - name: ðŸ§ª Run tests
      run: |
        moon test
        
    - name: ðŸ”§ Build project
      run: |
        moon build
        
    - name: ðŸ“¦ Package release
      run: |
        mkdir -p dist
        cp -r src dist/
        cp -r examples dist/
        cp README.md dist/
        cp moon.mod.json dist/
        cp moon.pkg.json dist/
        
    - name: ðŸ—œï¸ Create archive
      run: |
        cd dist
        tar -czf ../moonprogress-${{ github.ref_name }}.tar.gz .
        cd ..
        
    - name: ðŸ“‹ Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸŒ™ MoonProgress ${{ github.ref_name }}
        
        ### âœ¨ æ–°ç‰¹æ€§
        - ðŸš€ é›¶ä¾èµ–ã€é«˜æ€§èƒ½çš„å‘½ä»¤è¡Œè¿›åº¦æ¡
        - ðŸŽ¨ å¤šç§å†…ç½®æ ·å¼å’Œä¸°å¯Œçš„è‡ªå®šä¹‰é€‰é¡¹
        - ðŸ“Š å®Œæ•´çš„APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
        - âœ… å…¨é¢çš„æµ‹è¯•è¦†ç›–
        
        ### ðŸ“¦ å®‰è£…æ–¹å¼
        ```bash
        # å…‹éš†ä»“åº“
        git clone https://github.com/CGaaaaaa/MoonProgress.git
        cd MoonProgress
        
        # æž„å»ºé¡¹ç›®
        moon build
        
        # è¿è¡Œæµ‹è¯•
        moon test
        
        # è¿è¡Œç¤ºä¾‹
        cd examples && moon run cli_demo
        ```
        
        ### ðŸ”— ç›¸å…³é“¾æŽ¥
        - ðŸ“š [å®Œæ•´æ–‡æ¡£](https://github.com/CGaaaaaa/MoonProgress#readme)
        - ðŸ’¡ [ä½¿ç”¨ç¤ºä¾‹](https://github.com/CGaaaaaa/MoonProgress/tree/main/examples)
        - ðŸ§ª [æµ‹è¯•ç”¨ä¾‹](https://github.com/CGaaaaaa/MoonProgress/tree/main/tests)
        EOF
        
    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        files: |
          moonprogress-${{ github.ref_name }}.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}